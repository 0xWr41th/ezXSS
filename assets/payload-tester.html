<!DOCTYPE html>
<html>
<head>
    <title>ezXSS Payload Tester</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <style>
        .block { width: 20px; height: 20px; display: inline-block; }
        .circle { width: 20px; height: 20px; display: inline-block; border-radius: 10px; }
        .title { background-color: rgb(43,49,87); color: rgb(94,100,139); padding: 5px; }
        #table-wrap { display: none; }
        table { border-collapse: collapse; }
        th, td { border: 1px solid black; padding: 5px; }
    </style>
</head>
<body>
    <h1 class="title">ezXSS Payload Tester</h1>
    <p>This URL fires the ezXSS payload</p>
    <div id="browser"></div>

    <a href="#" onclick="window.location.reload(true); return false;">Reload page</a>
    <a href="/">Payload URL</a>
    <a href="/manage/payload">Manage Payload</a>
    <a href="https://github.com/ssl/ezXSS/wiki">ezXSS Wiki</a>

    <!-- Color tester -->
    <hr>
    <div class="block" style="background-color:red"></div>
    <div class="block" style="background-color:green"></div>
    <div class="block" style="background-color:blue"></div>
    <div class="block" style="background-color:yellow"></div>
    <div class="block" style="background-color:orange"></div>
    <div class="circle" style="background-color:red"></div>
    <div class="circle" style="background-color:green"></div>
    <div class="circle" style="background-color:blue"></div>
    <div class="circle" style="background-color:yellow"></div>
    <div class="circle" style="background-color:orange"></div><br>
    <div class="block" style="background-color:black"></div>
    <div class="block" style="background-color:white"></div>
    <div class="block" style="background-color:purple"></div>
    <div class="block" style="background-color:pink"></div>
    <div class="block" style="background-color:gray"></div>
    <div class="circle" style="background-color:black"></div>
    <div class="circle" style="background-color:white"></div>
    <div class="circle" style="background-color:purple"></div>
    <div class="circle" style="background-color:pink"></div>
    <div class="circle" style="background-color:gray"></div>
    <p>github.com/ssl/ezXSS</p>
    <div id="colors"></div>

    <script>
        // Global variables for request tracking
        var requestLog = [];

        // Escape function
        function esc(i) {
            return String(i).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        // Cross-browser event binding
        function addEvent(element, event, handler) {
            if (element.addEventListener) {
                element.addEventListener(event, handler, false);
            } else if (element.attachEvent) {
                element.attachEvent('on' + event, handler);
            }
        }

        // Browser details
        try {
            var browserDiv = document.getElementById('browser');
            browserDiv.innerHTML = '<p><b>Browser: </b>' + esc(navigator.appName) + ' ' + esc(navigator.appVersion) + '</p>';
        } catch (t) {}

        // Random color tester
        try {
            function initColors() {
                var colorsDiv = document.getElementById('colors');
                for (var i = 0; i < 10; i++) {
                    var color = '#' + Math.floor(Math.random() * 16777215).toString(16);
                    colorsDiv.innerHTML += '<div class="block" style="background-color:' + color + '"></div>';
                }
            }
            if (document.readyState === 'complete') {
                initColors();
            } else {
                addEvent(window, 'load', initColors);
            }
        } catch (t) {}

        // Storage and cookie tester
        try {
            if (typeof sessionStorage !== 'undefined') {
                sessionStorage.setItem('sessionStorageTester', Date.now());
            }
            if (typeof localStorage !== 'undefined') {
                localStorage.setItem('localStorageTester', Date.now());
            }
            document.cookie = 'CookieTester=' + Date.now();
        } catch (t) {}

        // Request logging function
        function logRequest(request) {
            try {
                requestLog.push(request);
                var tableBody = document.getElementById('requests').getElementsByTagName('tbody')[0];
                var newRow = document.createElement('tr');
                newRow.innerHTML = '<td>' + esc(request.method || 'UNKNOWN') + '</td>' +
                                   '<td>' + esc(request.url || 'UNKNOWN') + '</td>' +
                                   '<td>' + esc(request.status || 'PENDING') + '</td>';
                tableBody.appendChild(newRow);
                document.getElementById('table-wrap').style.display = 'block';
            } catch (e) {
                console.log('Error logging request:', e);
            }
        }

        // Non-interfering XMLHttpRequest monitoring
        (function() {
            try {
                if (window.XMLHttpRequest) {
                    var originalXhrOpen = XMLHttpRequest.prototype.open;
                    var originalXhrSend = XMLHttpRequest.prototype.send;

                    XMLHttpRequest.prototype.open = function(method, url) {
                        this._requestDetails = { method: method, url: url, status: null };
                        return originalXhrOpen.apply(this, arguments);
                    };

                    XMLHttpRequest.prototype.send = function(data) {
                        var xhr = this;
                        var details = xhr._requestDetails || { method: 'UNKNOWN', url: 'UNKNOWN' };
                        
                        // Store original onreadystatechange to avoid overwriting payload's handler
                        var originalOnReadyStateChange = xhr.onreadystatechange;
                        
                        var newOnReadyStateChange = function() {
                            if (xhr.readyState === 4) {
                                details.status = xhr.status;
                                logRequest(details);
                            }
                            
                            // Call original handler if it exists
                            if (originalOnReadyStateChange) {
                                originalOnReadyStateChange.apply(this, arguments);
                            }
                        };
                        
                        // Set our handler
                        xhr.onreadystatechange = newOnReadyStateChange;
                        
                        return originalXhrSend.apply(this, arguments);
                    };
                }
            } catch (e) {
                console.log('Error setting up XHR monitoring:', e);
            }
        })();

        // Payload status check (delayed until payload script loads)
        function checkPayloadStatus() {
            try {
                var statusDiv = document.createElement('div');
                statusDiv.innerHTML = '<h3>Payload Status</h3>' +
                                     'ezXSS payload initialized: <b>' + (typeof ez_nW === 'function' ? 'yes' : 'no') + '</b><br>' +
                                     'ezXSS screenshot initialized: <b>' + (typeof html2canvas === 'function' ? 'yes' : 'no') + '</b><br>' +
                                     'ezXSS persistent initialized: <b>' + (typeof ez_persist === 'function' ? 'yes' : 'no') + '</b>';
                document.body.appendChild(statusDiv);
            } catch (t) {
                console.log('Error in checkPayloadStatus:', t);
            }
        }

        // Initialize monitoring when page loads
        if (document.readyState === 'complete') {
            checkPayloadStatus();
        } else {
            addEvent(window, 'load', checkPayloadStatus);
        }
    </script>

    <!-- Load payload from main domain -->
    <script src="/"></script>

    <!-- HTTP requests table -->
    <div id="table-wrap">
        <hr>
        <h3>Network Activity</h3>
        <table id="requests" border="1">
            <thead>
                <tr>
                    <th>Method</th>
                    <th>URL</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</body>
</html>